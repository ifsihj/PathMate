import{_ as S,c as n,a as t,m as C,F as q,f as F,n as V,t as v,x as L,o as l,r as y,y as z,b as j,z as U,A as O,B as H,C as T,v as _,j as K,k as R,u as W,d as g,w as x,e as b}from"./index-kcQoswnZ.js";import{a as E,m as J,b as P,c as B,d as G,e as Q}from"./chatApi-CxDZByMz.js";const X={class:"chat-list"},Y={class:"chat-list-header"},Z={class:"chat-items"},ee=["onClick"],te={class:"chat-item-avatar"},se=["src","alt"],ae={key:1,class:"avatar-placeholder"},oe={key:2,class:"unread-badge"},ne={class:"chat-item-content"},le={class:"chat-item-header"},re={class:"chat-item-name"},ie={class:"chat-item-time"},ce={class:"chat-item-preview"},de={key:0,class:"chat-item-context"},ue=["onClick"],he={key:0,class:"empty-chat-list"},ve={__name:"ChatList",props:{chatList:{type:Array,default:()=>[]},activeChatId:{type:String,default:null}},emits:["select-chat","new-chat","delete-chat"],setup(c){const w=u=>{const o=new Date(u),r=new Date-o,i=Math.floor(r/36e5),p=Math.floor(r/864e5);return i<24?o.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):p<7?`${p}天前`:o.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})};return(u,o)=>(l(),n("div",X,[t("div",Y,[o[2]||(o[2]=t("h2",null,"聊天",-1)),t("button",{class:"new-chat-btn",onClick:o[0]||(o[0]=a=>u.$emit("new-chat")),title:"新聊天"},[...o[1]||(o[1]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),t("line",{x1:"5",y1:"12",x2:"19",y2:"12"})],-1)])])]),t("div",Z,[(l(!0),n(q,null,F(c.chatList,a=>(l(),n("div",{key:a.id,class:V(["chat-item",{active:c.activeChatId===a.id}]),onClick:r=>u.$emit("select-chat",a)},[t("div",te,[a.targetUserAvatar?(l(),n("img",{key:0,src:a.targetUserAvatar,alt:a.targetUserName},null,8,se)):(l(),n("div",ae,v(a.targetUserName?.charAt(0)||"U"),1)),a.unreadCount>0?(l(),n("span",oe,v(a.unreadCount),1)):C("",!0)]),t("div",ne,[t("div",le,[t("h3",re,v(a.targetUserName),1),t("span",ie,v(w(a.lastMessageTime)),1)]),t("p",ce,v(a.lastMessage||"还没有消息"),1),a.context?(l(),n("p",de,v(a.context),1)):C("",!0)]),t("button",{class:"delete-chat-btn",onClick:L(r=>u.$emit("delete-chat",a.id),["stop"]),title:"删除聊天"},[...o[3]||(o[3]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("polyline",{points:"3 6 5 6 21 6"}),t("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})],-1)])],8,ue)],10,ee))),128)),c.chatList.length===0?(l(),n("div",he,[...o[4]||(o[4]=[t("p",null,"还没有聊天记录",-1),t("p",{class:"empty-hint"},"点击上方按钮开始新聊天",-1)])])):C("",!0)])]))}},me=S(ve,[["__scopeId","data-v-6c37ff01"]]),fe={class:"chat-window"},ge={class:"chat-header"},we={class:"chat-user-info"},pe=["src","alt"],ye={key:1,class:"user-avatar-placeholder"},_e={class:"user-details"},ke={class:"user-name"},Ce={key:0,class:"chat-context"},Ie={key:0,class:"message-avatar"},xe=["src","alt"],$e={key:1,class:"avatar-placeholder"},Me={class:"message-content"},Ne={class:"message-bubble"},Ue={class:"message-text"},be={class:"message-time"},De={key:0,class:"empty-messages"},Ae={class:"chat-input-container"},Le={class:"input-wrapper"},Se=["onKeydown"],Te=["disabled"],Be={__name:"ChatWindow",props:{chatInfo:{type:Object,required:!0}},emits:["close","message-sent"],setup(c,{emit:w}){const u=c,o=w,a=y([]),r=y(""),i=y(null),p=y(null),k=y(!1),D=async()=>{try{k.value=!0;const d=await E(u.chatInfo.id);a.value=d,await U(),I(),await J(u.chatInfo.id)}catch(d){console.error("Failed to load messages:",d),_.error("加载消息失败")}finally{k.value=!1}},$=async()=>{if(!r.value.trim())return;const d=r.value.trim();r.value="";try{const e=await P(u.chatInfo.id,d);a.value.push(e),await U(),I(),o("message-sent",{chatId:u.chatInfo.id,lastMessage:d,lastMessageTime:e.timestamp})}catch(e){console.error("Failed to send message:",e),_.error("发送消息失败"),r.value=d}},I=()=>{i.value&&(i.value.scrollTop=i.value.scrollHeight)},A=d=>{const e=new Date(d),h=new Date-e,m=Math.floor(h/6e4),M=Math.floor(h/36e5),N=Math.floor(h/864e5);return m<1?"刚刚":m<60?`${m}分钟前`:M<24?`${M}小时前`:N<7?`${N}天前`:e.toLocaleDateString()};return z(a,()=>{U(()=>{I()})},{deep:!0}),j(()=>{D(),U(()=>{p.value&&p.value.focus()})}),(d,e)=>(l(),n("div",fe,[t("div",ge,[t("div",we,[c.chatInfo.targetUserAvatar?(l(),n("img",{key:0,src:c.chatInfo.targetUserAvatar,alt:c.chatInfo.targetUserName,class:"user-avatar"},null,8,pe)):(l(),n("div",ye,v(c.chatInfo.targetUserName?.charAt(0)||"U"),1)),t("div",_e,[t("h3",ke,v(c.chatInfo.targetUserName),1),c.chatInfo.context?(l(),n("p",Ce,v(c.chatInfo.context),1)):C("",!0)])]),t("button",{class:"close-btn",onClick:e[0]||(e[0]=s=>d.$emit("close"))},[...e[3]||(e[3]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])]),t("div",{class:"messages-container",ref_key:"messagesContainer",ref:i},[(l(!0),n(q,null,F(a.value,s=>(l(),n("div",{key:s.id,class:V(["message-item",{"message-sent":s.senderId==="current-user","message-received":s.senderId!=="current-user"}])},[s.senderId!=="current-user"?(l(),n("div",Ie,[c.chatInfo.targetUserAvatar?(l(),n("img",{key:0,src:c.chatInfo.targetUserAvatar,alt:c.chatInfo.targetUserName},null,8,xe)):(l(),n("div",$e,v(c.chatInfo.targetUserName?.charAt(0)||"U"),1))])):C("",!0),t("div",Me,[t("div",Ne,[t("p",Ue,v(s.content),1),t("span",be,v(A(s.timestamp)),1)])])],2))),128)),a.value.length===0?(l(),n("div",De,[...e[4]||(e[4]=[t("p",null,"还没有消息，开始聊天吧！",-1)])])):C("",!0)],512),t("div",Ae,[t("div",Le,[O(t("textarea",{"onUpdate:modelValue":e[1]||(e[1]=s=>r.value=s),onKeydown:[T(L($,["exact","prevent"]),["enter"]),e[2]||(e[2]=T(L(s=>r.value+=`
`,["shift","exact"]),["enter"]))],placeholder:"输入消息...",class:"message-input",rows:"1",ref_key:"messageInput",ref:p},null,40,Se),[[H,r.value]]),t("button",{class:"send-btn",onClick:$,disabled:!r.value.trim()},[...e[5]||(e[5]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),t("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})],-1)])],8,Te)])])]))}},qe=S(Be,[["__scopeId","data-v-1f33dfec"]]),Fe={class:"chat-view"},Ve={class:"chat-layout"},je={class:"chat-window-container"},ze={key:0,class:"chat-window-wrapper"},Oe={key:1,class:"no-chat-selected"},He={class:"empty-state"},Ke={__name:"ChatView",setup(c){const w=R(),u=W(),o=y([]),a=y(null),r=y(!1),i=y({userName:"",userId:"",context:""}),p=K(()=>a.value?o.value.find(e=>e.id===a.value):null),k=async()=>{try{const e=await G();o.value=e;const s=w.query.chatId;s&&e.find(h=>h.id===s)?a.value=s:e.length>0&&!a.value&&(a.value=e[0].id)}catch(e){console.error("Failed to load chat list:",e),_.error("加载聊天列表失败")}},D=e=>{a.value=e.id,u.replace({query:{chatId:e.id}})},$=async()=>{if(!i.value.userName.trim()){_.warning("请输入用户名");return}try{const e=i.value.userId||`user-${Date.now()}`,s=await B(e,i.value.userName,null,i.value.context||null);await k(),a.value=s.id,r.value=!1,d(),_.success("聊天已创建")}catch(e){console.error("Failed to create chat:",e),_.error("创建聊天失败")}},I=async e=>{try{await Q(e),await k(),a.value===e&&(a.value=null),_.success("聊天已删除")}catch(s){console.error("Failed to delete chat:",s),_.error("删除聊天失败")}},A=async e=>{const s=o.value.find(h=>h.id===e.chatId);s&&(s.lastMessage=e.lastMessage,s.lastMessageTime=e.lastMessageTime,localStorage.setItem("chat-list",JSON.stringify(o.value)))},d=()=>{i.value={userName:"",userId:"",context:""}};return j(()=>{k();const e=w.query.userId,s=w.query.userName,h=w.query.context;e&&s&&B(e,s,w.query.avatar||null,h).then(m=>{k().then(()=>{a.value=m.id,u.replace({query:{chatId:m.id}})})})}),(e,s)=>{const h=b("a-input"),m=b("a-form-item"),M=b("a-form"),N=b("a-modal");return l(),n("div",Fe,[t("div",Ve,[g(me,{"chat-list":o.value,"active-chat-id":a.value,onSelectChat:D,onNewChat:s[0]||(s[0]=f=>r.value=!0),onDeleteChat:I},null,8,["chat-list","active-chat-id"]),t("div",je,[p.value?(l(),n("div",ze,[g(qe,{"chat-info":p.value,onClose:s[1]||(s[1]=f=>a.value=null),onMessageSent:A},null,8,["chat-info"])])):(l(),n("div",Oe,[t("div",He,[s[7]||(s[7]=t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})],-1)),s[8]||(s[8]=t("p",null,"选择一个聊天开始对话",-1)),t("button",{class:"start-chat-btn",onClick:s[2]||(s[2]=f=>r.value=!0)}," 开始新聊天 ")])]))])]),g(N,{open:r.value,"onUpdate:open":s[6]||(s[6]=f=>r.value=f),title:"开始新聊天",width:500,onOk:$,onCancel:d},{default:x(()=>[g(M,{model:i.value,"label-col":{span:6},"wrapper-col":{span:18}},{default:x(()=>[g(m,{label:"用户名",required:""},{default:x(()=>[g(h,{value:i.value.userName,"onUpdate:value":s[3]||(s[3]=f=>i.value.userName=f),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),g(m,{label:"用户ID"},{default:x(()=>[g(h,{value:i.value.userId,"onUpdate:value":s[4]||(s[4]=f=>i.value.userId=f),placeholder:"可选：用户ID"},null,8,["value"])]),_:1}),g(m,{label:"上下文"},{default:x(()=>[g(h,{value:i.value.context,"onUpdate:value":s[5]||(s[5]=f=>i.value.context=f),placeholder:"可选：聊天上下文（如Path标题）"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])])}}},Ee=S(Ke,[["__scopeId","data-v-f7c2ae91"]]);export{Ee as default};
